rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is admin (with fallback for initialization)
    function isAdmin() {
      return isAuthenticated() && (
        // Check if user document exists and user is admin
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true)
        ||
        // Fallback: Allow admin creation if no users exist yet (initialization)
        (!exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         request.auth.token.email == 'admin@vavidiaapp.com')
      );
    }

    // Helper function to check if user is active
    function isActiveUser() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true;
    }

    // Helper function to check if user owns the shop or is admin
    function canAccessShop(shopId) {
      return isAdmin() ||
             (isActiveUser() &&
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.shopId == shopId);
    }

    // Users collection - allow admin creation during initialization
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write: if isAuthenticated() && (
        // Allow admin to manage all users
        isAdmin() ||
        // Allow user creation if it's for the current user and they are admin email
        (request.auth.uid == userId && request.auth.token.email == 'admin@vavidiaapp.com') ||
        // Allow sample user creation during initialization
        (request.auth.uid == userId && request.auth.token.email == 'user@example.com')
      );
    }

    // Shops collection - allow creation during initialization
    match /shops/{shopId} {
      allow read: if isAuthenticated() && (isAdmin() ||
        (isActiveUser() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.shopId == shopId));
      allow write: if isAuthenticated() && (
        isAdmin() ||
        // Allow shop creation during initialization by admin email
        request.auth.token.email == 'admin@vavidiaapp.com'
      );
    }

    // Accounts collection - allow creation during initialization
    match /accounts/{accountId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        isAdmin() ||
        // Allow account creation during initialization
        request.auth.token.email == 'admin@vavidiaapp.com'
      );
      allow create: if isAuthenticated() && (
        isAdmin() ||
        // Allow account creation during initialization
        request.auth.token.email == 'admin@vavidiaapp.com'
      );
    }

    // Financial Years collection - allow creation during initialization
    match /financialYears/{fyId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        isAdmin() ||
        // Allow financial year creation during initialization
        request.auth.token.email == 'admin@accounting-app.com'
      );
      allow create: if isAuthenticated() && (
        isAdmin() ||
        // Allow financial year creation during initialization
        request.auth.token.email == 'admin@accounting-app.com'
      );
    }

    // Transactions collection - shop-based access control (stricter after initialization)
    match /transactions/{transactionId} {
      allow read, write: if isActiveUser() && canAccessShop(resource.data.shopId);
      allow create: if isActiveUser() && canAccessShop(request.resource.data.shopId);
    }

    // Logs collection - users can read their shop's logs, admins can read all
    match /logs/{logId} {
      allow read: if isActiveUser() && (isAdmin() || canAccessShop(resource.data.shopId));
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // Notifications collection - users can read/update their own notifications
    match /notifications/{notificationId} {
      allow read, update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow delete: if isAdmin();
    }
  }
}