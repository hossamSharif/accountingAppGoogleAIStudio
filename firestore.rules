rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is admin (with fallback for initialization)
    function isAdmin() {
      return isAuthenticated() && (
        // Check if user document exists and user is admin
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true)
        ||
        // Fallback: Allow admin creation if no users exist yet (initialization)
        (!exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         request.auth.token.email == 'admin@accounting-app.com')
        ||
        // Additional check: if user document exists and is admin (simpler check)
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
    }

    // Helper function to check if user is active
    function isActiveUser() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true;
    }

    // Helper function to check if user owns the shop or is admin
    function canAccessShop(shopId) {
      return isAdmin() ||
             (isActiveUser() &&
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.shopId == shopId);
    }

    // Users collection - allow admin to create and manage users
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow create: if isAuthenticated() && (
        // Allow admin to create any user
        isAdmin() ||
        // Allow user creation if it's for the current user during initialization
        (request.auth.uid == userId && (
          request.auth.token.email == 'admin@accounting-app.com' ||
          request.auth.token.email == 'user@example.com'
        ))
      );
      allow update, delete: if isAuthenticated() && (
        // Allow admin to manage all users
        isAdmin() ||
        // Allow user to update their own profile (except role and isActive)
        (request.auth.uid == userId &&
         !('role' in request.resource.data) &&
         !('isActive' in request.resource.data))
      );
    }

    // Shops collection - allow creation during initialization
    match /shops/{shopId} {
      allow read: if isAuthenticated() && (isAdmin() ||
        (isActiveUser() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.shopId == shopId));
      allow write: if isAuthenticated() && (
        isAdmin() ||
        // Allow shop creation during initialization by admin email
        request.auth.token.email == 'admin@accounting-app.com'
      );
    }

    // Accounts collection - allow users to create sub-accounts for their shop
    match /accounts/{accountId} {
      allow read: if isAuthenticated();

      // Allow creation if:
      // 1. User is admin, OR
      // 2. User is creating account for their own shop AND account has a parentId (sub-account)
      allow create: if isAuthenticated() && (
        isAdmin() ||
        // Allow account creation during initialization
        request.auth.token.email == 'admin@accounting-app.com' ||
        // Allow users to create sub-accounts for their shop
        (isActiveUser() &&
         request.resource.data.shopId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.shopId &&
         'parentId' in request.resource.data &&
         request.resource.data.parentId != null)
      );

      // Allow update if admin or user owns the shop
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (isActiveUser() &&
         resource.data.shopId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.shopId)
      );

      // Only admins can delete accounts
      allow delete: if isAdmin();
    }

    // Financial Years collection - allow creation during initialization
    match /financialYears/{fyId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        isAdmin() ||
        // Allow financial year creation during initialization
        request.auth.token.email == 'admin@accounting-app.com'
      );
      allow create: if isAuthenticated() && (
        isAdmin() ||
        // Allow financial year creation during initialization
        request.auth.token.email == 'admin@accounting-app.com'
      );
    }

    // Transactions collection - shop-based access control
    match /transactions/{transactionId} {
      allow read: if isActiveUser() && (
        isAdmin() ||
        (resource != null && canAccessShop(resource.data.shopId))
      );
      allow write: if isActiveUser() && (
        isAdmin() ||
        (resource != null && canAccessShop(resource.data.shopId))
      );
      allow create: if isActiveUser() && (
        isAdmin() ||
        canAccessShop(request.resource.data.shopId)
      );
    }

    // Logs collection - users can read their shop's logs, admins can read all
    match /logs/{logId} {
      allow read: if isActiveUser() && (
        isAdmin() ||
        (resource != null && canAccessShop(resource.data.shopId))
      );
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // Notifications collection - users can read/update their own notifications
    match /notifications/{notificationId} {
      allow read, update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow delete: if isAdmin();
    }
  }
}